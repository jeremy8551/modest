# This workflow will build a Java project with Maven, and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-maven

name: Automatic Deployment

on:
  workflow_dispatch:
    inputs:
      snapshot:
        description: 'Use snapshot version'
        required: true
        default: ''
        type: choice
        options:
          - ''
          - '-SNAPSHOT'

jobs:
  build:
    strategy:
      fail-fast: false

    # 运行的操作系统
    runs-on: ubuntu-latest

    # 环境变量
    env:
      TZ: Asia/Shanghai   # 设置时区为中国标准时间

    steps:
      # 拉取代码
      - name: Git clone
        uses: actions/checkout@v4

      # 安装 JDK8
      - name: Set up JDK 8
        id: jdk8
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '8'

      # 安装 JDK17
      - name: Set up JDK 17
        id: jdk17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # 安装 GPG
      - name: Install GPG
        run: |
          sudo apt-get update
          sudo apt-get install -y gnupg2
          gpg --version

      # 导入私钥
      - name: Import GPG private key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.MAVEN_GPG_PRIVATE_KEY }}
        run: |
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import

      # 可选：列出密钥验证
      - name: List GPG keys
        run: gpg --list-secret-keys --keyid-format LONG

      # 生成 toolchains.xml 并写入 ~/.m2
      - name: Configure Maven Toolchains
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/toolchains-modest.xml <<EOF
          <toolchains>
            <toolchain>
              <type>jdk</type>
              <provides>
                <version>5</version>
              </provides>
              <configuration>
                <jdkHome>${{ steps.jdk8.outputs.path }}</jdkHome>
              </configuration>
            </toolchain>
          
            <toolchain>
              <type>jdk</type>
              <provides>
                <version>6</version>
              </provides>
              <configuration>
                <jdkHome>${{ steps.jdk8.outputs.path }}</jdkHome>
              </configuration>
            </toolchain>
          
            <toolchain>
              <type>jdk</type>
              <provides>
                <version>7</version>
              </provides>
              <configuration>
                <jdkHome>${{ steps.jdk8.outputs.path }}</jdkHome>
              </configuration>
            </toolchain>
          
            <toolchain>
              <type>jdk</type>
              <provides>
                <version>8</version>
              </provides>
              <configuration>
                <jdkHome>${{ steps.jdk8.outputs.path }}</jdkHome>
              </configuration>
            </toolchain>
          
            <toolchain>
              <type>jdk</type>
              <provides>
                <version>12</version>
              </provides>
              <configuration>
                <jdkHome>${{ steps.jdk17.outputs.path }}</jdkHome>
              </configuration>
            </toolchain>
          
            <toolchain>
              <type>jdk</type>
              <provides>
                <version>17</version>
              </provides>
              <configuration>
                <jdkHome>${{ steps.jdk17.outputs.path }}</jdkHome>
              </configuration>
            </toolchain>
          </toolchains>
          EOF

      - name: Verify Toolchains.xml
        run: cat ~/.m2/toolchains-modest.xml

      # 生成 settings.xml 并写入 ~/.m2
      - name: Configure Maven settings.xml
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd">
            <pluginGroups></pluginGroups>
            <proxies></proxies>
          
            <servers>
              <server>
                <id>central-repository</id>
                <username>${{ secrets.CENTRAL_REPOSITORY_USERNAME }}</username>
                <password>${{ secrets.CENTRAL_REPOSITORY_PASSWORD }}</password>
              </server>
            </servers>
          
            <profiles>
              <profile>
                <id>enable-deploy-config</id>
                <properties>
                  <gpg.executable>gpg</gpg.executable>
                  <gpg.passphrase>${{ secrets.MAVEN_GPG_PASSPHRASE }}</gpg.passphrase> <!-- GPG 密钥的密码 -->
                </properties>
          
                <!-- 工件下载仓库 -->
                <repositories>
                  <repository>
                    <id>central-repository-snapshots</id>
                    <url>https://central.sonatype.com/repository/maven-snapshots/</url>
          
                    <releases>
                      <enabled>false</enabled>
                    </releases>
                    <snapshots>
                      <enabled>true</enabled>
                      <updatePolicy>always</updatePolicy>
                    </snapshots>
                  </repository>
          
                  <repository>
                    <id>central-repository-release</id>
                    <url>https://repo1.maven.org/maven2/</url>
                    <snapshots>
                      <enabled>false</enabled>
                    </snapshots>
                  </repository>
                </repositories>
          
                <!-- 插件下载仓库 -->
                <pluginRepositories>
                  <pluginRepository>
                    <id>central-pluginRepository-snapshot</id>
                    <url>https://central.sonatype.com/repository/maven-snapshots/</url>
                    <snapshots>
                      <enabled>true</enabled>
                    <updatePolicy>always</updatePolicy>
                    </snapshots>
                  </pluginRepository>
          
                  <pluginRepository>
                    <id>central-pluginRepository-release</id>
                    <url>https://repo1.maven.org/maven2/</url>
                    <snapshots>
                      <enabled>false</enabled>
                    </snapshots>
                  </pluginRepository>
                </pluginRepositories>
              </profile>
          
              <profile>
                <id>enable-dockerHub-login</id>
                <activation>
                    <activeByDefault>true</activeByDefault>
                </activation>
                <properties>
                    <dockerhub.login.username>${{ secrets.DOCKER_HUB_USERNAME }}</dockerhub.login.username>
                    <dockerhub.login.password>${{ secrets.DOCKER_HUB_PASSWORD }}</dockerhub.login.password>
                </properties>
              </profile>
            </profiles>
          </settings>
          EOF

      - name: Verify settings.xml
        run: cat ~/.m2/settings.xml

      - name: Build with Maven
        run: |
          # 保存当前分支名
          current_branch=$(git rev-parse --abbrev-ref HEAD)
          echo "当前分支名: ${current_branch}"

          if [[ "$current_branch" == "feature_"* ]]; then
            branch_name=${current_branch#feature_}
            branch_version=${branch_name#v}
          else
            # 查找最新提交记录中的版本号
            branch_version=$(git log -1 --pretty=format:"%B" | grep -oE '^v[0-9]+\.[0-9]+\.[0-9]+([[:space:]]|$)')
          fi

          echo "./mvnw clean deploy -Drevision=${branch_version}${{ github.event.inputs.snapshot }} -Dmaven.test.skip=true -P enable-deploy,enable-deploy-config"
          ./mvnw clean deploy -Drevision=${branch_version}${{ github.event.inputs.snapshot }} -Dmaven.test.skip=true -P enable-deploy,enable-deploy-config

      - name: Docker Login
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      - name: Docker build and push
        uses: docker/build-push-action@v6
        with:
          context: ./modest-build
          file: ./modest-build/target/Dockerfile
          push: true
          tags: |
            docker.io/${{ secrets.DOCKER_HUB_USERNAME }}/jdksetup:latest
            docker.io/${{ secrets.DOCKER_HUB_USERNAME }}/jdksetup:${branch_version}

      # 成功时发邮件
      - name: Send mail (success)
        if: success()   # 只有成功时才会执行
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_PASSWORD }}
          subject: "✅ Modest 项目部署成功"
          to: "jeremy8551@qq.com"
          from: "GitHub Actions <${{ secrets.GMAIL_USERNAME }}@gmail.com>"
          body: |
            Modest 项目部署成功 ✅
            ./mvnw clean deploy -Dmaven.test.skip=true -P enable-deploy,enable-deploy-config
            请登录 GitHub Actions 查看详细日志: 
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

      # 失败时发邮件
      - name: Send mail (failure)
        if: failure()   # 只有失败时才会执行
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_PASSWORD }}
          subject: "❌ Modest 项目部署失败"
          to: "jeremy8551@qq.com"
          from: "GitHub Actions <${{ secrets.GMAIL_USERNAME }}@gmail.com>"
          body: |
            Modest 项目部署失败 ❌
            ./mvnw clean deploy -Dmaven.test.skip=true -P enable-deploy,enable-deploy-config
            请登录 GitHub Actions 查看详细日志: 
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}